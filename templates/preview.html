<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Preview â€” EduAIHub Mailer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <h2>Preview & Confirm</h2>
      <p>Found <strong>{{ count }}</strong> recipients. Scroll to preview the email.</p>

      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Subject</h5>
          <p>{{ subject }}</p>
          {% if product_name %}
            <h5 class="card-title">Product</h5>
            <p>{{ product_name }}</p>
          {% endif %}
          <h5 class="card-title">From</h5>
          <p>{{ sender_name if sender_name else 'Configured SMTP Email' }}</p>
          {% if custom_mode and ai_personalize == '1' %}
            <div class="alert alert-info mt-2">Personalization enabled: messages will be personalized per recipient using their name from the uploaded file.</div>
          {% endif %}
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="card mb-3">
            <div class="card-body">
              <h5>Recipients</h5>
              <form id="previewForm" method="post" action="{% if custom_mode %}/custom-start-send{% elif greeting_mode %}/greetings-start-send{% else %}{{ '/product-start-send' if product_key else '/start-send' }}{% endif %}">
                <textarea name="emails" class="form-control" rows="10">{% for e in emails %}{{ e }}
{% endfor %}</textarea>
                <input type="hidden" name="subject" value="{{ subject }}">
                <input type="hidden" name="sender_name" value="{{ sender_name }}">
                {% if product_key %}
                  <input type="hidden" name="product_key" value="{{ product_key }}">
                {% endif %}
                {% if custom_note %}
                  <input type="hidden" name="custom_note" value="{{ custom_note }}">
                {% endif %}
                {% if intro %}
                  <input type="hidden" name="intro" value="{{ intro|e }}">
                {% endif %}
                {% if custom_attachments %}
                  <input type="hidden" name="custom_attachments" value="{{ custom_attachments }}">
                {% endif %}
                {% if recipient_data %}
                  <input type="hidden" name="recipient_data" value="{{ recipient_data|e }}">
                {% endif %}
                {% if greeting_mode %}
                  <input type="hidden" name="greeting_kind" value="{{ greeting_kind }}">
                {% endif %}

                <!-- include the rendered HTML so confirm step shows the exact preview -->
                <textarea name="email_html" style="display:none;">{{ email_html|e }}</textarea>
                <!-- For greetings we also include a fragment (no header/footer). Sending will use this fragment to render per-recipient to avoid duplicate headers/footers -->
                {% if greeting_mode %}
                  <input type="hidden" name="email_fragment" value="{{ email_fragment|e }}">
                {% endif %}
                <!-- For custom mode include recipient data and personalization flag -->
                {% if custom_mode %}
                  {% if recipient_data %}
                    <input type="hidden" name="recipient_data" value="{{ recipient_data|e }}">
                  {% endif %}
                  <input type="hidden" name="ai_personalize" value="1">
                  {% if email_fragment %}
                    <input type="hidden" name="email_fragment" value="{{ email_fragment|e }}">
                    <input type="hidden" name="fragment_has_greeting" value="{{ fragment_has_greeting if fragment_has_greeting else '0' }}">
                    <input type="hidden" name="fragment_needs_greeting" value="{{ '1' if not fragment_has_greeting else '0' }}">
                  {% endif %}
                  <input type="hidden" name="use_ai" value="0">

                  <!-- Pass chosen template and optional event fields through to the send step -->
                  <input type="hidden" name="template" value="{{ template if template else '' }}">
                  <input type="hidden" name="cta_text" value="{{ cta_text if cta_text else '' }}">
                  <input type="hidden" name="cta_link" value="{{ cta_link if cta_link else '' }}">
                  <input type="hidden" name="event_date" value="{{ event_date if event_date else '' }}">
                  <input type="hidden" name="event_time" value="{{ event_time if event_time else '' }}">
                  <input type="hidden" name="event_location" value="{{ event_location if event_location else '' }}">
                {% endif %}

                <!-- Pass any user-provided structure/css through as well -->
                <input type="hidden" name="structure_html" value="{{ structure_html|e if structure_html else '' }}">
                <input type="hidden" name="structure_css" value="{{ structure_css|e if structure_css else '' }}">
                <!-- If AI returned a canonical full HTML, pass it through for the send step -->
                <input type="hidden" name="canonical_ai_html" value="{{ canonical_ai_html|e if canonical_ai_html else '' }}">
                <div class="mt-2">
                  <form id="sendPreviewForm" method="post" action="/send-preview" class="row g-2 align-items-center">
                    <div class="col-auto">
                      <label class="form-label" for="testEmail">Send preview to</label>
                    </div>
                    <div class="col">
                      <input id="testEmail" name="test_email" class="form-control" type="email" placeholder="your.email@example.com">
                      <div class="form-text">Sends the exact preview HTML to the address you provide (use for verification).</div>
                    </div>
                    <input type="hidden" name="subject" value="{{ subject }}">
                    <input type="hidden" name="sender_name" value="{{ sender_name }}">
                    <input type="hidden" name="canonical_ai_html" value="{{ canonical_ai_html|e if canonical_ai_html else '' }}">
                    <textarea name="email_html" style="display:none;">{% if canonical_ai_html %}{{ canonical_ai_html }}{% else %}{{ email_html }}{% endif %}</textarea>
                    <div class="col-auto">
                      <button id="sendPreviewBtn" class="btn btn-outline-primary" type="submit">Send preview</button>
                    </div>
                  </form>
                </div>

                <div id="countdownArea" style="display:none;margin-top:12px;">
                  <div class="alert alert-warning d-flex justify-content-between align-items-center">
                    <div id="countdownText">Sending in <strong id="count">5</strong> seconds...</div>
                    <div>
                      <button id="cancelBtn" class="btn btn-sm btn-outline-dark" type="button">Cancel</button>
                    </div>
                  </div>
                </div>

              </form>

              <script>
                (function(){
                  const sendBtn = document.getElementById('sendBtn');
                  const countdownArea = document.getElementById('countdownArea');
                  const countEl = document.getElementById('count');
                  const cancelBtn = document.getElementById('cancelBtn');
                  const form = document.getElementById('previewForm');
                  let timer = null;
                  let seconds = 5;

                  function startCountdown(){
                    // if dry run selected, submit immediately
                    if(document.getElementById('dryRun').checked){
                      form.submit();
                      return;
                    }
                    seconds = 5;
                    countEl.textContent = seconds;
                    countdownArea.style.display = 'block';
                    sendBtn.disabled = true;
                    timer = setInterval(()=>{
                      seconds -= 1;
                      countEl.textContent = seconds;
                      if(seconds <= 0){
                        clearInterval(timer);
                        form.submit();
                      }
                    }, 1000);
                  }

                  function cancelCountdown(){
                    if(timer) clearInterval(timer);
                    countdownArea.style.display = 'none';
                    sendBtn.disabled = false;
                  }

                  sendBtn.addEventListener('click', startCountdown);
                  cancelBtn.addEventListener('click', cancelCountdown);
                })();
              </script>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card mb-3">
            <div class="card-body">
              <h5>Email Preview</h5>
              <div style="border:1px solid #ddd;padding:10px;max-height:600px;overflow:auto;">
                {% if canonical_ai_html %}
                  {{ canonical_ai_html|safe }}
                {% else %}
                  {{ email_html|safe }}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
